<!DOCTYPE html>
<html>
<head>
    <script src="https://nosir.github.io/obelisk.js/dist/obelisk.min.1.0.2.js"></script>
    <style>
        canvas {
            padding: 0;
            margin: auto;
            display: block;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            image-rendering: crisp-edges;
        }

        #main {
            border: 1px solid black;
            z-index: -1;
            height: min(90vh, 67.5vw);
            aspect-ratio: 4 / 3;
        }

        #character {
            z-index: 1;
            height: min(15vh, 11.25vw);
            border: 1px solid black;
        }

    </style>
</head>
<body>
    <canvas id="main" width="256" height="192"></canvas>
    <canvas id="character" width="32" height="32"></canvas>
    
    <script>
        
        // Environment

        let GLOBAL_WIDTH_CENTER = 127;
        let GLOBAL_HEIGHT_CENTER = 97;

        const canvas = document.getElementById("main");
        const ctxMain = canvas.getContext("2d");

        let point = new obelisk.Point(GLOBAL_WIDTH_CENTER, GLOBAL_HEIGHT_CENTER);
        let pixelView = new obelisk.PixelView(canvas, point);

        const dimension = new obelisk.CubeDimension(128, 128, 5);
        const gray = obelisk.ColorPattern.GRAY;
        const color = new obelisk.CubeColor().getByHorizontalColor(gray);

        const cube = new obelisk.Cube(dimension, color, true);
        let p3d = new obelisk.Point3D(0, 0, 33);

        function renderEnvironment() {
            let point = new obelisk.Point(GLOBAL_WIDTH_CENTER, GLOBAL_HEIGHT_CENTER);
            let pixelView = new obelisk.PixelView(canvas, point);
            ctxMain.clearRect(0, 0, canvas.width, canvas.height);
            pixelView.renderObject(cube, p3d);
        }

        document.body.onload = function() {
            renderEnvironment();
        }

        // -----------------------------------------

        // Character

        const LEFT_STILL = 0;
        const LEFT_WALK_1 = 32;
        const LEFT_WALK_2 = 64;
        const RIGHT_STILL = 96;
        const RIGHT_WALK_1 = 128;
        const RIGHT_WALK_2 = 160;

        const character = document.getElementById("character");
        const context = character.getContext('2d');
        let image = new Image();
        image.src = '/sprites/character-spritesheet.png';

        image.onload = function() {
            context.drawImage(
                image,
                //this var contols frame
                LEFT_STILL,
                // ------------------
                0,
                32,
                32,
                0,
                0,
                32,
                32
            );
        }

        // -----------------------------------------

         // Sprite Animation Function

        let animationRunning = false;
        const charInt = 15;
        const envInt = 2;
        let leftCount = 0;
        let rightCount = 0;
        let facingLeft = true;
        let up = false;
        let down = false;
        let left = false;
        let right = false;

            function moveLeft() {
                if (animationRunning) {
                    if (leftCount == 0) {
                        context.clearRect(0, 0, image.width, image.height);
                        context.drawImage(image, LEFT_WALK_1, 0, 32, 32, 0, 0, 32, 32);
                    } else if (leftCount == charInt) {
                        context.clearRect(0, 0, image.width, image.height);
                        context.drawImage(image, LEFT_WALK_2, 0, 32, 32, 0, 0, 32, 32);
                    }
                    leftCount = (leftCount + 1) % (charInt * 2);
                    
                    if (up && left) {
                        GLOBAL_WIDTH_CENTER+=envInt;
                        GLOBAL_HEIGHT_CENTER+=envInt;
                    } else if (down && left) {
                        GLOBAL_WIDTH_CENTER+=envInt;
                        GLOBAL_HEIGHT_CENTER-=envInt;
                    } else if (up) {
                        GLOBAL_HEIGHT_CENTER+=envInt;
                    } else if (down) {
                        GLOBAL_HEIGHT_CENTER-=envInt;
                    } else {
                        GLOBAL_WIDTH_CENTER+=envInt;
                    }
                    
                    renderEnvironment();
                    requestAnimationFrame(moveLeft);
                }
            }

            function moveRight() {
                if (animationRunning) {
                    if (rightCount == 0) {
                    context.clearRect(0, 0, image.width, image.height);
                    context.drawImage(image, RIGHT_WALK_1, 0, 32, 32, 0, 0, 32, 32);
                    } else if (rightCount == charInt) {
                        context.clearRect(0, 0, image.width, image.height);
                        context.drawImage(image, RIGHT_WALK_2, 0, 32, 32, 0, 0, 32, 32);
                    }
                    rightCount = (rightCount + 1) % (charInt * 2);

                    if (up && right) {
                        GLOBAL_WIDTH_CENTER-=envInt;
                        GLOBAL_HEIGHT_CENTER+=envInt;
                    } else if (down && right) {
                        GLOBAL_WIDTH_CENTER-=envInt;
                        GLOBAL_HEIGHT_CENTER-=envInt;
                    } else if (up) {
                        GLOBAL_HEIGHT_CENTER+=envInt;
                    } else if (down) {
                        GLOBAL_HEIGHT_CENTER-=envInt;
                    } else {
                        GLOBAL_WIDTH_CENTER-=envInt;
                    }
                    
                    renderEnvironment();
                    requestAnimationFrame(moveRight);
                }
            }

        // -----------------------------------------


        // Movement Logic

        function handleKeyDown(event) {
            // Log the key code for debugging
            console.log("Key pressed:", event.keyCode);

            switch (event.key) {
                case "ArrowUp":
                case "W":
                case "w":
                    if (!down) {
                        up = true;
                        if (!animationRunning) {
                            animationRunning = true;
                            if (facingLeft) {
                                requestAnimationFrame(moveLeft);
                            } else {
                                requestAnimationFrame(moveRight);
                            }
                        }
                    }
                    break;
                case "ArrowDown":
                case "S":
                case "s":
                    if (!up) {
                        down = true;
                        if (!animationRunning) {
                            animationRunning = true;
                            if (facingLeft) {
                                requestAnimationFrame(moveLeft);
                            } else {
                                requestAnimationFrame(moveRight);
                            }
                        }
                    }
                    break;
                case "ArrowLeft":
                case "A":
                case "a":
                    facingLeft = true;
                    if (!right) {
                        left = true;
                        if (!animationRunning) {
                            animationRunning = true;
                            requestAnimationFrame(moveLeft);
                        }
                    }
                    break;
                case "ArrowRight":
                case "D":
                case "d":
                    facingLeft = false;
                    if (!left) {
                        right = true;
                        if (!animationRunning) {
                            animationRunning = true;
                            requestAnimationFrame(moveRight);
                        }       
                    }     
                    break;
                case "ArrowUpArrowLeft":
                case "ES":
                case "es":
                    left = true;
                    up = true;
                    if (!animationRunning) {
                        animationRunning = true;
                        requestAnimationFrame(moveLeft);
                    }
                    break;
                case "ArrowDownArrowLeft":
                case "DS":
                case "ds":
                    left = true;
                    down = true;
                    if (!animationRunning) {
                        animationRunning = true;
                        requestAnimationFrame(moveLeft);
                    }
                    break;
                case "ArrowUpArrowRight":
                case "EF":
                case "ef":
                    right = true;
                    up = true;
                    if (!animationRunning) {
                        animationRunning = true;
                        requestAnimationFrame(moveRight);
                    }                
                    break;
                case "ArrowDownArrowRight":
                case "DF":
                case "df":
                    right = true;
                    down = true;
                    if (!animationRunning) {
                        animationRunning = true;
                        requestAnimationFrame(moveRight);
                    }                
                    break;
                default:
                    // Ignore other keys
                    break;
            }
        }

        function handleKeyUp(event) {
                switch(event.key) {
                    case "ArrowUp":
                    case "W":
                    case "w":
                        up = false;
                        if (!right && !left) {
                            animationRunning = false;
                            context.clearRect(0, 0, image.width, image.height);
                            if (facingLeft) {
                                context.drawImage(image, LEFT_STILL, 0, 32, 32, 0, 0, 32, 32);
                            } else {
                                context.drawImage(image, RIGHT_STILL, 0, 32, 32, 0, 0, 32, 32);
                            }
                        }
                        break;
                    case "ArrowDown":
                    case "S":
                    case "s":
                        down = false;
                        if (!right && !left) {
                            animationRunning = false;
                            context.clearRect(0, 0, image.width, image.height);
                            if (facingLeft) {
                                context.drawImage(image, LEFT_STILL, 0, 32, 32, 0, 0, 32, 32);
                            } else {
                                context.drawImage(image, RIGHT_STILL, 0, 32, 32, 0, 0, 32, 32);
                            }
                        }
                        break;
                    case "ArrowLeft":
                    case "A":
                    case "a":
                        left = false;
                        if (!up && !down) {
                            animationRunning = false;
                            context.clearRect(0, 0, image.width, image.height);
                            context.drawImage(image, LEFT_STILL, 0, 32, 32, 0, 0, 32, 32);
                        }
                        break;
                    case "ArrowRight":
                    case "D":
                    case "d":
                        right = false;
                        if (!up && !down) {
                            animationRunning = false;
                            context.clearRect(0, 0, image.width, image.height);
                            context.drawImage(image, RIGHT_STILL, 0, 32, 32, 0, 0, 32, 32);
                        }
                        break;
                }
        }

        document.body.addEventListener("keydown", handleKeyDown);
        document.body.addEventListener("keyup", handleKeyUp);


        // -----------------------------------------

       


    </script>
</body>
</html>